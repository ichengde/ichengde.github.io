<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>socket | chegde 杂货店</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="sockets 可以说是 standard Unix file descriptors。read() write() 也可以，但是send() and recv() 会有更好的控制。A file descriptor is simply an integer associated with an open file. But (and here’s the catch), that file ca">
<meta property="og:type" content="article">
<meta property="og:title" content="socket">
<meta property="og:url" content="http://chegde.github.io/2018/09/02/socket/index.html">
<meta property="og:site_name" content="chegde 杂货店">
<meta property="og:description" content="sockets 可以说是 standard Unix file descriptors。read() write() 也可以，但是send() and recv() 会有更好的控制。A file descriptor is simply an integer associated with an open file. But (and here’s the catch), that file ca">
<meta property="og:updated_time" content="2018-09-17T15:25:51.312Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="socket">
<meta name="twitter:description" content="sockets 可以说是 standard Unix file descriptors。read() write() 也可以，但是send() and recv() 会有更好的控制。A file descriptor is simply an integer associated with an open file. But (and here’s the catch), that file ca">
  
    <link rel="alternate" href="/atom.xml" title="chegde 杂货店" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">chegde 杂货店</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://chegde.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-socket" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/09/02/socket/" class="article-date">
  <time datetime="2018-09-02T13:47:12.000Z" itemprop="datePublished">2018-09-02</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      socket
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>sockets 可以说是 standard Unix file descriptors。<br>read() write() 也可以，但是send() and recv() 会有更好的控制。A file descriptor is simply an integer associated with an open file. But (and here’s the catch), that file can be a network connection, a FIFO, a pipe, a terminal, a real on-the-disk file, or just about anything else. Everything in Unix is a file!</p>
<h3 id="两种-Internet-Sockets"><a href="#两种-Internet-Sockets" class="headerlink" title="两种 Internet Sockets"></a>两种 Internet Sockets</h3><p>Stream sockets 就是用的 TCP （the transimission control protocol）。IP 代表的是 Internet Protocol。<br>Datagram sockets 用 UDP （User Datagram protocol）。 tftp (trivial file transfer protocol, a little brother to FTP), dhcpcd (a DHCP client), multiplayer games, streaming audio, video conferencing, etc. </p>
<h3 id="IP-Addresses"><a href="#IP-Addresses" class="headerlink" title="IP Addresses"></a>IP Addresses</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">sa</span>;</span> <span class="comment">// IPv4</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in6</span> <span class="title">sa6</span>;</span> <span class="comment">// IPv6</span></span><br><span class="line">inet_pton(AF_INET, <span class="string">"10.12.110.57"</span>, &amp;(sa.sin_addr)); <span class="comment">// IPv4</span></span><br><span class="line">inet_pton(AF_INET6, <span class="string">"2001:db8:63b3:1::3490"</span>, &amp;(sa6.sin6_addr)); <span class="comment">// IPv6</span></span><br></pre></td></tr></table></figure>
<p>该函数将IP地址转换为 sockaddr_in 结构。<br>“pton” stands for “presentation to network”—you can call it “printable to network” if that’s easier to remember.<br>以前这个功能的函数叫 inet_addr 或者是 inet_aton, 但是用不了 ipv6 了。</p>
<p>inet_ntop()  “ntop” means “network to presentation”<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> ip4[INET_ADDRSTRLEN]; <span class="comment">// space to hold the IPv4 string</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">sa</span>;</span> <span class="comment">// pretend this is loaded with something</span></span><br><span class="line">inet_ntop(AF_INET, &amp;(sa.sin_addr), ip4, INET_ADDRSTRLEN);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"The IPv4 address is: %s\n"</span>, ip4);</span><br></pre></td></tr></table></figure></p>
<p>getaddrinfo() 可以得到IP地址。</p>
<h3 id="socket"><a href="#socket" class="headerlink" title="socket()"></a>socket()</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">socket</span><span class="params">(<span class="keyword">int</span> domain, <span class="keyword">int</span> type, <span class="keyword">int</span> protocol)</span></span>;</span><br></pre></td></tr></table></figure>
<p>参数可以硬编码，(domain is PF_INET or PF_INET6, type is SOCK_STREAM or SOCK_DGRAM, and protocol can be set to 0 to choose the proper protocol for the given type<br>也可以用getprotobyname() 传”TCP” “UDP”</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> s;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">addrinfo</span> <span class="title">hints</span>, *<span class="title">res</span>;</span></span><br><span class="line"><span class="comment">// do the lookup</span></span><br><span class="line"><span class="comment">// [pretend we already filled out the "hints" struct]</span></span><br><span class="line">getaddrinfo(<span class="string">"www.example.com"</span>, <span class="string">"http"</span>, &amp;hints, &amp;res);</span><br><span class="line"><span class="comment">// [again, you should do error-checking on getaddrinfo(), and walk</span></span><br><span class="line"><span class="comment">// the "res" linked list looking for valid entries instead of just</span></span><br><span class="line"><span class="comment">// assuming the first one is good (like many of these examples do.)</span></span><br><span class="line"><span class="comment">// See the section on client/server for real examples.]</span></span><br><span class="line">s = socket(res-&gt;ai_family, res-&gt;ai_socktype, res-&gt;ai_protocol);</span><br></pre></td></tr></table></figure>
<p>socket 调用成功则返回 a socket descriptor， 失败返回-1。<br>全局变量 errno 将会被设置。</p>
<p>一旦你有了 socket，你应该将它跟本地机器的端口绑定。<br>服务端就需要 listen(), 客户端需要 connect()。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">bind</span><span class="params">(<span class="keyword">int</span> sockfd, struct sockaddr *my_addr, <span class="keyword">int</span> addrlen)</span></span>;</span><br></pre></td></tr></table></figure>
<p>sockfd 就是 a socket descriptor, my_addr 需要指向 struct sockaddr，addrlen 是地址的字节数的长度</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">addrinfo</span> <span class="title">hints</span>, *<span class="title">res</span>;</span></span><br><span class="line"><span class="keyword">int</span> sockfd;</span><br><span class="line"><span class="comment">// first, load up address structs with getaddrinfo():</span></span><br><span class="line"><span class="built_in">memset</span>(&amp;hints, <span class="number">0</span>, <span class="keyword">sizeof</span> hints);</span><br><span class="line">hints.ai_family = AF_UNSPEC; <span class="comment">// use IPv4 or IPv6, whichever</span></span><br><span class="line">hints.ai_socktype = SOCK_STREAM;</span><br><span class="line">hints.ai_flags = AI_PASSIVE; <span class="comment">// fill in my IP for me</span></span><br><span class="line">getaddrinfo(<span class="literal">NULL</span>, <span class="string">"3490"</span>, &amp;hints, &amp;res);</span><br><span class="line"><span class="comment">// make a socket:</span></span><br><span class="line">sockfd = socket(res-&gt;ai_family, res-&gt;ai_socktype, res-&gt;ai_protocol);</span><br><span class="line"><span class="comment">// bind it to the port we passed in to getaddrinfo():</span></span><br><span class="line">bind(sockfd, res-&gt;ai_addr, res-&gt;ai_addrlen);</span><br></pre></td></tr></table></figure>
<p>如果已经被绑定了<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// lose the pesky "Address already in use" error message</span></span><br><span class="line"><span class="keyword">if</span> (setsockopt(listener,SOL_SOCKET,SO_REUSEADDR,&amp;yes,<span class="keyword">sizeof</span> yes) == <span class="number">-1</span>) &#123;</span><br><span class="line">perror(<span class="string">"setsockopt"</span>);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>其实客户端连接不用关心 bind(), 你调用 connect() 它会检查 socket 是否 unbound, 需要的话 它会自行绑定到本地未使用的端口。</p>
<h3 id="Connect"><a href="#Connect" class="headerlink" title="Connect"></a>Connect</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">connect</span><span class="params">(<span class="keyword">int</span> sockfd, struct sockaddr *serv_addr, <span class="keyword">int</span> addrlen)</span></span>;</span><br></pre></td></tr></table></figure>
<p>sockfd is our friendly neighborhood socket file descriptor, as returned by the socket() call, serv_addr is a struct sockaddr containing the destination port and IP address, and addrlen is the length in bytes of the server address structure.</p>
<p>建立一个socket 连接：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">addrinfo</span> <span class="title">hints</span>, *<span class="title">res</span>;</span></span><br><span class="line"><span class="keyword">int</span> sockfd;</span><br><span class="line"><span class="comment">// first, load up address structs with getaddrinfo():</span></span><br><span class="line"><span class="built_in">memset</span>(&amp;hints, <span class="number">0</span>, <span class="keyword">sizeof</span> hints);</span><br><span class="line">hints.ai_family = AF_UNSPEC;</span><br><span class="line">hints.ai_socktype = SOCK_STREAM;</span><br><span class="line">getaddrinfo(<span class="string">"www.example.com"</span>, <span class="string">"3490"</span>, &amp;hints, &amp;res);</span><br><span class="line"><span class="comment">// make a socket:</span></span><br><span class="line">sockfd = socket(res-&gt;ai_family, res-&gt;ai_socktype, res-&gt;ai_protocol);</span><br><span class="line"></span><br><span class="line"><span class="comment">// connect!</span></span><br><span class="line">connect(sockfd, res-&gt;ai_addr, res-&gt;ai_addrlen);</span><br></pre></td></tr></table></figure></p>
<p>旧的写法会填充 sockaddr_ins.<br>确保 connect 返回的值不等于-1, 不然要去检查一下 errno. 别担心端口, 无需 bind, 内核会做这些事.</p>
<h3 id="listen"><a href="#listen" class="headerlink" title="listen()"></a>listen()</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">listen</span><span class="params">(<span class="keyword">int</span> sockfd, <span class="keyword">int</span> backlog)</span></span>;</span><br></pre></td></tr></table></figure>
<p>sockfd 就是 socket file descriptor. backlog 是所能允许的连接数. 进入的连接在等待, 大多数系统默认限制为20, 你可以设置它.<br>跟以往一样, 当listen() 返回 -1 时, 需要检查 errno.<br>显然, 在调用 listen() 时, 先需要 bind(). </p>
<p>所以, 调用的顺序基本上是<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">getaddrinfo();</span><br><span class="line">socket();</span><br><span class="line">bind();</span><br><span class="line">listen();</span><br><span class="line"><span class="comment">/* accept() goes here */</span></span><br></pre></td></tr></table></figure></p>
<h3 id="accept"><a href="#accept" class="headerlink" title="accept()"></a>accept()</h3><p>连接都在等待被 Accept(). 你调用 accept(), 然后等待准备的连接, 它将放回全新的一个 socket file descriptor. 原来的 socket 仍然在等待新的连接, 全新的 socket 可以使用 send() 和 recv().</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">accept</span><span class="params">(<span class="keyword">int</span> sockfd, struct sockaddr *addr, <span class="keyword">socklen_t</span> *addrlen)</span></span>;</span><br></pre></td></tr></table></figure>
<p>错误处理一如既往. addr 指向本地的 struct sockaddr_storage. addrlen 应该是 sizeof(struct sockaddr_storage).</p>
<p>至此, 总结一下上面的吧：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MYPORT <span class="meta-string">"3490"</span>  <span class="comment">// the port users will be connecting to</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BACKLOG 10     <span class="comment">// how many pending connections queue will hold</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_storage</span> <span class="title">their_addr</span>;</span></span><br><span class="line">    <span class="keyword">socklen_t</span> addr_size;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">addrinfo</span> <span class="title">hints</span>, *<span class="title">res</span>;</span></span><br><span class="line">    <span class="keyword">int</span> sockfd, new_fd;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// !! don't forget your error checking for these calls !!</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// first, load up address structs with getaddrinfo():</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(&amp;hints, <span class="number">0</span>, <span class="keyword">sizeof</span> hints);</span><br><span class="line">    hints.ai_family = AF_UNSPEC;  <span class="comment">// use IPv4 or IPv6, whichever</span></span><br><span class="line">    hints.ai_socktype = SOCK_STREAM;</span><br><span class="line">    hints.ai_flags = AI_PASSIVE;     <span class="comment">// fill in my IP for me</span></span><br><span class="line"></span><br><span class="line">    getaddrinfo(<span class="literal">NULL</span>, MYPORT, &amp;hints, &amp;res);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// make a socket, bind it, and listen on it:</span></span><br><span class="line"></span><br><span class="line">    sockfd = socket(res-&gt;ai_family, res-&gt;ai_socktype, res-&gt;ai_protocol);</span><br><span class="line">    bind(sockfd, res-&gt;ai_addr, res-&gt;ai_addrlen);</span><br><span class="line">    listen(sockfd, BACKLOG);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// now accept an incoming connection:</span></span><br><span class="line"></span><br><span class="line">    addr_size = <span class="keyword">sizeof</span> their_addr;</span><br><span class="line">    new_fd = accept(sockfd, (struct sockaddr *)&amp;their_addr, &amp;addr_size);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ready to communicate on socket descriptor new_fd!</span></span><br><span class="line">    .</span><br><span class="line">    .</span><br></pre></td></tr></table></figure></p>
<p>new_fd 是新的, 如果你不想要再接受新的连接, 直接调用 close() 也行.</p>
<h3 id="send-and-recv"><a href="#send-and-recv" class="headerlink" title="send() and recv()"></a>send() and recv()</h3><p>TCP 用这两个.<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">send</span><span class="params">(<span class="keyword">int</span> sockfd, <span class="keyword">const</span> <span class="keyword">void</span> *msg, <span class="keyword">int</span> len, <span class="keyword">int</span> flags)</span></span>;</span><br></pre></td></tr></table></figure></p>
<p>样例如:<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> *msg = <span class="string">"Beej was here!"</span>;</span><br><span class="line"><span class="keyword">int</span> len, bytes_sent;</span><br><span class="line">.</span><br><span class="line">.</span><br><span class="line">.</span><br><span class="line">len = <span class="built_in">strlen</span>(msg);</span><br><span class="line">bytes_sent = send(sockfd, msg, len, <span class="number">0</span>);</span><br><span class="line">.</span><br><span class="line">.</span><br></pre></td></tr></table></figure></p>
<p>send() 会返回实际上发送出去的数据大小. 如果一次性发送过大的数据量, 剩余的你要处理并继续发送. 如果整个数据包小于1KB, 可讷讷个不用担心这个问题.<br>错误处理-1.</p>
<p>recv() 有很多相似的地方.<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">recv</span><span class="params">(<span class="keyword">int</span> sockfd, <span class="keyword">void</span> *buf, <span class="keyword">int</span> len, <span class="keyword">int</span> flags)</span></span>;</span><br></pre></td></tr></table></figure></p>
<p>recv() 返回真实收到的字节数大小. 错误处理-1, 如果返回0, 说明对面关闭连接了.</p>
<h3 id="sendto-和-recvfrom-–-datagram-style"><a href="#sendto-和-recvfrom-–-datagram-style" class="headerlink" title="sendto() 和 recvfrom() – datagram style"></a>sendto() 和 recvfrom() – datagram style</h3><p>datagram socket 不需要连接远程主机。<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sendto</span><span class="params">(<span class="keyword">int</span> sockfd, <span class="keyword">const</span> <span class="keyword">void</span> *msg, <span class="keyword">int</span> len, <span class="keyword">unsigned</span> <span class="keyword">int</span> flags,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="keyword">const</span> struct sockaddr *to, <span class="keyword">socklen_t</span> tolen)</span></span>;</span><br></pre></td></tr></table></figure></p>
<p>跟 send() 相比, 这个函数就多两个参数。 sockaddr 包含了远程主机的地址和端口, tolen 其实就是 sockaddr 的长度.</p>
<p>sendto() 返回参数的意义和 send() 一样.</p>
<p>你可以用 getaddrinfo(), recvfrom(), 或者 你手工填充 *to 的数据.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">recvfrom</span><span class="params">(<span class="keyword">int</span> sockfd, <span class="keyword">void</span> *buf, <span class="keyword">int</span> len, <span class="keyword">unsigned</span> <span class="keyword">int</span> flags,</span></span></span><br><span class="line"><span class="function"><span class="params">struct sockaddr *from, <span class="keyword">int</span> *fromlen)</span></span>;</span><br></pre></td></tr></table></figure>
<p>多两个额外字段, 可见 sendto(). 返回结果如 recv 一致.</p>
<p>struct sockaddr_storage 可以让我们不要局限于 struct sockaddr_in 中. 通用结构 sockaddr_storage 足够容纳这两者. ( 为什么不能直接用 struct sockaddr 还要用 struct sockaddr_storage 去转成 struct sockaddr？ 看起来很冗余. 就是因为 stcuct sockaddr 不能容纳, 所以他们做了一个新的.)</p>
<h3 id="close-and-shutdown"><a href="#close-and-shutdown" class="headerlink" title="close() and shutdown()"></a>close() and shutdown()</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">close(sockfd);</span><br></pre></td></tr></table></figure>
<p>它会阻止所有的读写在这个 socket file descriptor. 强行读写, 将发生错误.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">shutdown</span><span class="params">(<span class="keyword">int</span> sockfd, <span class="keyword">int</span> how)</span></span>;</span><br></pre></td></tr></table></figure>
<p>这个函数拥有更细颗粒的控制度.</p>
<ul>
<li>0 Further receives are disallowed</li>
<li>1 Further sends are disallowed</li>
<li>2 Further sends and receives are disallowed (like close())</li>
</ul>
<p>成功 返回 0 失败 返回 -1.</p>
<p>shutdown() 不能真正关闭 socket file desciptor, 只是改变了可用度. 为了释放它, 你需要使用 close(). (如果是 windows 平台, 那就使用 closesocket(). )</p>
<h3 id="getpeername"><a href="#getpeername" class="headerlink" title="getpeername()"></a>getpeername()</h3><p>The function getpeername() will tell you who is at the other end of a connected stream socket</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">getpeername</span><span class="params">(<span class="keyword">int</span> sockfd, struct sockaddr *addr, <span class="keyword">int</span> *addrlen)</span></span>;</span><br></pre></td></tr></table></figure>
<p>sockfd 已经连接的sfd, addr 指向 sockaddr 的指针, addrlen -&gt; sizeof *addr.<br>inet_ntop(), getnameinfo(), or gethostbyaddr() 可以得到更多信息.<br>The function returns -1 on error and sets errno accordingly.</p>
<h3 id="gethostname"><a href="#gethostname" class="headerlink" title="gethostname()"></a>gethostname()</h3><p>It returns the name of the computer that your program is running on</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">gethostname</span><span class="params">(<span class="keyword">char</span> *hostname, <span class="keyword">size_t</span> size)</span></span>;</span><br></pre></td></tr></table></figure>
<p>hostname is a pointer to an array of chars that will contain the hostname upon the function’s return, and size is the length in bytes of the hostname array. The function returns 0 on successful completion, and -1 on error, setting errno as usual.</p>
<h2 id="Client-Server-Background"><a href="#Client-Server-Background" class="headerlink" title="Client-Server Background"></a>Client-Server Background</h2><p>there will only be one server on a machine, and that server will handle multiple clients using<br>fork(). The basic routine is: server will wait for a connection, accept() it, and fork() a child process to<br>handle it. This is what our sample server does in the next section.</p>
<p>多进程处理连接。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">** server.c -- a stream socket server demo</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netdb.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PORT <span class="meta-string">"3490"</span> <span class="comment">// the port users will be connecting to</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BACKLOG 10 <span class="comment">// how many pending connections queue will hold</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sigchld_handler</span><span class="params">(<span class="keyword">int</span> s)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// waitpid() might overwrite errno, so we save and restore it:</span></span><br><span class="line">  <span class="keyword">int</span> saved_errno = errno;</span><br><span class="line">  <span class="keyword">while</span> (waitpid(<span class="number">-1</span>, <span class="literal">NULL</span>, WNOHANG) &gt; <span class="number">0</span>);</span><br><span class="line">  errno = saved_errno;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// get sockaddr, IPv4 or IPv6:</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> * <span class="title">get_in_addr</span><span class="params">(struct sockaddr * sa)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (sa -&gt; sa_family == AF_INET) &#123;</span><br><span class="line">    <span class="keyword">return</span> &amp;(((struct sockaddr_in * ) sa) -&gt; sin_addr);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> &amp;(((struct sockaddr_in6 * ) sa) -&gt; sin6_addr);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> sockfd, new_fd; <span class="comment">// listen on sock_fd, new connection on new_fd</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">addrinfo</span> <span class="title">hints</span>, * <span class="title">servinfo</span>, * <span class="title">p</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_storage</span> <span class="title">their_addr</span>;</span> <span class="comment">// connector's address information</span></span><br><span class="line">  <span class="keyword">socklen_t</span> sin_size;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">sigaction</span> <span class="title">sa</span>;</span></span><br><span class="line">  <span class="keyword">int</span> yes = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">char</span> s[INET6_ADDRSTRLEN];</span><br><span class="line">  <span class="keyword">int</span> rv;</span><br><span class="line">  <span class="built_in">memset</span>( &amp; hints, <span class="number">0</span>, <span class="keyword">sizeof</span> hints);</span><br><span class="line">  hints.ai_family = AF_UNSPEC;</span><br><span class="line">  hints.ai_socktype = SOCK_STREAM;</span><br><span class="line">  hints.ai_flags = AI_PASSIVE; <span class="comment">// use my IP</span></span><br><span class="line">  <span class="keyword">if</span> ((rv = getaddrinfo(<span class="literal">NULL</span>, PORT, &amp; hints, &amp; servinfo)) != <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"getaddrinfo: %s\n"</span>, gai_strerror(rv));</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// loop through all the results and bind to the first we can</span></span><br><span class="line">  <span class="keyword">for</span> (p = servinfo; p != <span class="literal">NULL</span>; p = p -&gt; ai_next) &#123;</span><br><span class="line">    <span class="keyword">if</span> ((sockfd = socket(p -&gt; ai_family, p -&gt; ai_socktype,</span><br><span class="line">        p -&gt; ai_protocol)) == <span class="number">-1</span>) &#123;</span><br><span class="line">      perror(<span class="string">"server: socket"</span>);</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (setsockopt(sockfd, SOL_SOCKET, SO_REUSEADDR, &amp; yes,</span><br><span class="line">        <span class="keyword">sizeof</span>(<span class="keyword">int</span>)) == <span class="number">-1</span>) &#123;</span><br><span class="line">      perror(<span class="string">"setsockopt"</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (bind(sockfd, p -&gt; ai_addr, p -&gt; ai_addrlen) == <span class="number">-1</span>) &#123;</span><br><span class="line">      close(sockfd);</span><br><span class="line">      perror(<span class="string">"server: bind"</span>);</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  freeaddrinfo(servinfo); <span class="comment">// all done with this structure</span></span><br><span class="line">  <span class="keyword">if</span> (p == <span class="literal">NULL</span>) &#123;</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"server: failed to bind\n"</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (listen(sockfd, BACKLOG) == <span class="number">-1</span>) &#123;</span><br><span class="line">    perror(<span class="string">"listen"</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  sa.sa_handler = sigchld_handler; <span class="comment">// reap all dead processes</span></span><br><span class="line">  sigemptyset( &amp; sa.sa_mask);</span><br><span class="line">  sa.sa_flags = SA_RESTART;</span><br><span class="line">  <span class="keyword">if</span> (sigaction(SIGCHLD, &amp; sa, <span class="literal">NULL</span>) == <span class="number">-1</span>) &#123;</span><br><span class="line">    perror(<span class="string">"sigaction"</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"server: waiting for connections...\n"</span>);</span><br><span class="line">  <span class="keyword">while</span> (<span class="number">1</span>) &#123; <span class="comment">// main accept() loop</span></span><br><span class="line">    sin_size = <span class="keyword">sizeof</span> their_addr;</span><br><span class="line">    new_fd = accept(sockfd, (struct sockaddr * ) &amp; their_addr, &amp; sin_size);</span><br><span class="line">    <span class="keyword">if</span> (new_fd == <span class="number">-1</span>) &#123;</span><br><span class="line">      perror(<span class="string">"accept"</span>);</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    inet_ntop(their_addr.ss_family,</span><br><span class="line">      get_in_addr((struct sockaddr * ) &amp; their_addr),</span><br><span class="line">      s, <span class="keyword">sizeof</span> s);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"server: got connection from %s\n"</span>, s);</span><br><span class="line">    <span class="keyword">if</span> (!fork()) &#123; <span class="comment">// this is the child process</span></span><br><span class="line">      close(sockfd); <span class="comment">// child doesn't need the listener</span></span><br><span class="line">      <span class="keyword">if</span> (send(new_fd, <span class="string">"Hello, world!"</span>, <span class="number">13</span>, <span class="number">0</span>) == <span class="number">-1</span>)</span><br><span class="line">        perror(<span class="string">"send"</span>);</span><br><span class="line">      close(new_fd);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    close(new_fd); <span class="comment">// parent doesn't need this</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>sigaction() 主要负责杀死没有连接的 fork() 的僵尸进程.</p>
<h2 id="A-Simple-Stream-Client"><a href="#A-Simple-Stream-Client" class="headerlink" title="A Simple Stream Client"></a>A Simple Stream Client</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">** client.c -- a stream socket client demo</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netdb.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PORT <span class="meta-string">"3490"</span> <span class="comment">// the port client will be connecting to</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAXDATASIZE 100 <span class="comment">// max number of bytes we can get at once</span></span></span><br><span class="line"><span class="comment">// get sockaddr, IPv4 or IPv6:</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> * <span class="title">get_in_addr</span><span class="params">(struct sockaddr * sa)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (sa -&gt; sa_family == AF_INET) &#123;</span><br><span class="line">    <span class="keyword">return</span> &amp;(((struct sockaddr_in * ) sa) -&gt; sin_addr);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> &amp;(((struct sockaddr_in6 * ) sa) -&gt; sin6_addr);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> * argv[])</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> sockfd, numbytes;</span><br><span class="line">  <span class="keyword">char</span> buf[MAXDATASIZE];</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">addrinfo</span> <span class="title">hints</span>, * <span class="title">servinfo</span>, * <span class="title">p</span>;</span></span><br><span class="line">  <span class="keyword">int</span> rv;</span><br><span class="line">  <span class="keyword">char</span> s[INET6_ADDRSTRLEN];</span><br><span class="line">  <span class="keyword">if</span> (argc != <span class="number">2</span>) &#123;</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"usage: client hostname\n"</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">memset</span>( &amp; hints, <span class="number">0</span>, <span class="keyword">sizeof</span> hints);</span><br><span class="line">  hints.ai_family = AF_UNSPEC;</span><br><span class="line">  hints.ai_socktype = SOCK_STREAM;</span><br><span class="line">  <span class="keyword">if</span> ((rv = getaddrinfo(argv[<span class="number">1</span>], PORT, &amp; hints, &amp; servinfo)) != <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"getaddrinfo: %s\n"</span>, gai_strerror(rv));</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// loop through all the results and connect to the first we can</span></span><br><span class="line">  <span class="keyword">for</span> (p = servinfo; p != <span class="literal">NULL</span>; p = p -&gt; ai_next) &#123;</span><br><span class="line">    <span class="keyword">if</span> ((sockfd = socket(p -&gt; ai_family, p -&gt; ai_socktype,</span><br><span class="line">        p -&gt; ai_protocol)) == <span class="number">-1</span>) &#123;</span><br><span class="line">      perror(<span class="string">"client: socket"</span>);</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (connect(sockfd, p -&gt; ai_addr, p -&gt; ai_addrlen) == <span class="number">-1</span>) &#123;</span><br><span class="line">      close(sockfd);</span><br><span class="line">      perror(<span class="string">"client: connect"</span>);</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (p == <span class="literal">NULL</span>) &#123;</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"client: failed to connect\n"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  inet_ntop(p -&gt; ai_family, get_in_addr((struct sockaddr * ) p -&gt; ai_addr),</span><br><span class="line">    s, <span class="keyword">sizeof</span> s);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"client: connecting to %s\n"</span>, s);</span><br><span class="line">  freeaddrinfo(servinfo); <span class="comment">// all done with this structure</span></span><br><span class="line">  <span class="keyword">if</span> ((numbytes = recv(sockfd, buf, MAXDATASIZE - <span class="number">1</span>, <span class="number">0</span>)) == <span class="number">-1</span>) &#123;</span><br><span class="line">    perror(<span class="string">"recv"</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  buf[numbytes] = <span class="string">'\0'</span>;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"client: received '%s'\n"</span>, buf);</span><br><span class="line">  close(sockfd);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果服务端没开启, 将返回 Connection refused.</p>
<h3 id="Datagram-Sockets"><a href="#Datagram-Sockets" class="headerlink" title="Datagram Sockets"></a>Datagram Sockets</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">** listener.c -- a datagram sockets "server" demo</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netdb.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MYPORT <span class="meta-string">"4950"</span>    <span class="comment">// the port users will be connecting to</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAXBUFLEN 100</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// get sockaddr, IPv4 or IPv6:</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">get_in_addr</span><span class="params">(struct sockaddr *sa)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (sa-&gt;sa_family == AF_INET) &#123;</span><br><span class="line">        <span class="keyword">return</span> &amp;(((struct sockaddr_in*)sa)-&gt;sin_addr);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &amp;(((struct sockaddr_in6*)sa)-&gt;sin6_addr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> sockfd;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">addrinfo</span> <span class="title">hints</span>, *<span class="title">servinfo</span>, *<span class="title">p</span>;</span></span><br><span class="line">    <span class="keyword">int</span> rv;</span><br><span class="line">    <span class="keyword">int</span> numbytes;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_storage</span> <span class="title">their_addr</span>;</span></span><br><span class="line">    <span class="keyword">char</span> buf[MAXBUFLEN];</span><br><span class="line">    <span class="keyword">socklen_t</span> addr_len;</span><br><span class="line">    <span class="keyword">char</span> s[INET6_ADDRSTRLEN];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(&amp;hints, <span class="number">0</span>, <span class="keyword">sizeof</span> hints);</span><br><span class="line">    hints.ai_family = AF_UNSPEC; <span class="comment">// set to AF_INET to force IPv4</span></span><br><span class="line">    hints.ai_socktype = SOCK_DGRAM;</span><br><span class="line">    hints.ai_flags = AI_PASSIVE; <span class="comment">// use my IP</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((rv = getaddrinfo(<span class="literal">NULL</span>, MYPORT, &amp;hints, &amp;servinfo)) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"getaddrinfo: %s\n"</span>, gai_strerror(rv));</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// loop through all the results and bind to the first we can</span></span><br><span class="line">    <span class="keyword">for</span>(p = servinfo; p != <span class="literal">NULL</span>; p = p-&gt;ai_next) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((sockfd = socket(p-&gt;ai_family, p-&gt;ai_socktype,</span><br><span class="line">                p-&gt;ai_protocol)) == <span class="number">-1</span>) &#123;</span><br><span class="line">            perror(<span class="string">"listener: socket"</span>);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (bind(sockfd, p-&gt;ai_addr, p-&gt;ai_addrlen) == <span class="number">-1</span>) &#123;</span><br><span class="line">            close(sockfd);</span><br><span class="line">            perror(<span class="string">"listener: bind"</span>);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (p == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"listener: failed to bind socket\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    freeaddrinfo(servinfo);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"listener: waiting to recvfrom...\n"</span>);</span><br><span class="line"></span><br><span class="line">    addr_len = <span class="keyword">sizeof</span> their_addr;</span><br><span class="line">    <span class="keyword">if</span> ((numbytes = recvfrom(sockfd, buf, MAXBUFLEN<span class="number">-1</span> , <span class="number">0</span>,</span><br><span class="line">        (struct sockaddr *)&amp;their_addr, &amp;addr_len)) == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror(<span class="string">"recvfrom"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"listener: got packet from %s\n"</span>,</span><br><span class="line">        inet_ntop(their_addr.ss_family,</span><br><span class="line">            get_in_addr((struct sockaddr *)&amp;their_addr),</span><br><span class="line">            s, <span class="keyword">sizeof</span> s));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"listener: packet is %d bytes long\n"</span>, numbytes);</span><br><span class="line">    buf[numbytes] = <span class="string">'\0'</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"listener: packet contains \"%s\"\n"</span>, buf);</span><br><span class="line"></span><br><span class="line">    close(sockfd);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">** talker.c -- a datagram "client" demo</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netdb.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SERVERPORT <span class="meta-string">"4950"</span>    <span class="comment">// the port users will be connecting to</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> sockfd;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">addrinfo</span> <span class="title">hints</span>, *<span class="title">servinfo</span>, *<span class="title">p</span>;</span></span><br><span class="line">    <span class="keyword">int</span> rv;</span><br><span class="line">    <span class="keyword">int</span> numbytes;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (argc != <span class="number">3</span>) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>,<span class="string">"usage: talker hostname message\n"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(&amp;hints, <span class="number">0</span>, <span class="keyword">sizeof</span> hints);</span><br><span class="line">    hints.ai_family = AF_UNSPEC;</span><br><span class="line">    hints.ai_socktype = SOCK_DGRAM;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((rv = getaddrinfo(argv[<span class="number">1</span>], SERVERPORT, &amp;hints, &amp;servinfo)) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"getaddrinfo: %s\n"</span>, gai_strerror(rv));</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// loop through all the results and make a socket</span></span><br><span class="line">    <span class="keyword">for</span>(p = servinfo; p != <span class="literal">NULL</span>; p = p-&gt;ai_next) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((sockfd = socket(p-&gt;ai_family, p-&gt;ai_socktype,</span><br><span class="line">                p-&gt;ai_protocol)) == <span class="number">-1</span>) &#123;</span><br><span class="line">            perror(<span class="string">"talker: socket"</span>);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (p == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"talker: failed to create socket\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((numbytes = sendto(sockfd, argv[<span class="number">2</span>], <span class="built_in">strlen</span>(argv[<span class="number">2</span>]), <span class="number">0</span>,</span><br><span class="line">             p-&gt;ai_addr, p-&gt;ai_addrlen)) == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror(<span class="string">"talker: sendto"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    freeaddrinfo(servinfo);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"talker: sent %d bytes to %s\n"</span>, numbytes, argv[<span class="number">1</span>]);</span><br><span class="line">    close(sockfd);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Slightly-Advanced-Techniques"><a href="#Slightly-Advanced-Techniques" class="headerlink" title="Slightly Advanced Techniques"></a>Slightly Advanced Techniques</h3><h4 id="Blocking"><a href="#Blocking" class="headerlink" title="Blocking"></a>Blocking</h4><p>recvfrom() 在等待数据的时候处于阻塞状态，许多函数调用都会如此，accept()会阻塞，recv()也会阻塞。当新创建一个 socket 时，内核默认阻塞。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">sockfd = socket(PF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">fcntl(sockfd, F_SETFL, O_NONBLOCK);</span><br></pre></td></tr></table></figure>
<p>错误的话，返回-1，error 将被设置为 EAGAIN or EWOULDBLOCK。</p>
<h4 id="select-同步-I-O-复用"><a href="#select-同步-I-O-复用" class="headerlink" title="select() 同步 I/O 复用"></a>select() 同步 I/O 复用</h4><p>当非阻塞的情况下，一边 accept() 一边 recv()，将导致CPU时间混乱。 select() 可以同时掌控几个 socket，它虽然很便捷，但是速度最慢。考虑 libevent 来作为替代品吧，对系统调用 socket 进行了封装。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">select</span><span class="params">(<span class="keyword">int</span> numfds, fd_set *readfds, fd_set *writefds,</span></span></span><br><span class="line"><span class="function"><span class="params">           fd_set *exceptfds, struct timeval *timeout)</span></span>;</span><br></pre></td></tr></table></figure>
<p>该函数掌控 file descriptor 的集合：readfds, writefds 和 exceptfds. 如果你想要读标准输入和某一 socket , 就把 file descriptors 0 和 sockfd 加入到 readfds 的集合中. 参数 numfds 设置为 file descriptor 的最大值 + 1. 当 select() 返回的时候, readfds 对应了即将操作的 socket. 可以用 FD_ISSET() 宏进行测试.</p>
<h6 id="一些宏函数"><a href="#一些宏函数" class="headerlink" title="一些宏函数"></a>一些宏函数</h6><p>FD_SET(int fd, fd_set <em>set); Add fd to the set.<br>FD_CLR(int fd, fd_set </em>set); Remove fd from the set.<br>FD_ISSET(int fd, fd_set <em>set); Return true if fd is in the set.<br>FD_ZERO(fd_set </em>set); Clear all entries from the set.</p>
<p>struct timeval 相当于超时设置.<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> &#123;</span></span><br><span class="line"><span class="keyword">int</span> tv_sec; <span class="comment">// seconds</span></span><br><span class="line"><span class="keyword">int</span> tv_usec; <span class="comment">// microseconds</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>如果将struct timeval中的字段设置为0，则select（）立即超时，有效地轮询集合中的所有文件描述符。 如果将参数timeout设置为<br>NULL，它将等到第一个文件描述符准备就绪. 最后，如果你不在乎关于等待某个集合，你可以在调用select（）时将其设置为NULL.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">** select.c -- a select() demo</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> STDIN 0 <span class="comment">// file descriptor for standard input</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">tv</span>;</span></span><br><span class="line">  fd_set readfds;</span><br><span class="line">  tv.tv_sec = <span class="number">2</span>;</span><br><span class="line">  tv.tv_usec = <span class="number">500000</span>;</span><br><span class="line">  FD_ZERO(&amp;readfds);</span><br><span class="line">  FD_SET(STDIN, &amp;readfds);</span><br><span class="line">  <span class="comment">// don't care about writefds and exceptfds:</span></span><br><span class="line">  select(STDIN+<span class="number">1</span>, &amp;readfds, <span class="literal">NULL</span>, <span class="literal">NULL</span>, &amp;tv);</span><br><span class="line">  <span class="keyword">if</span> (FD_ISSET(STDIN, &amp;readfds))</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"A key was pressed!\n"</span>);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Timed out.\n"</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://chegde.github.io/2018/09/02/socket/" data-id="cjm6fzg3x000b9y8w0w00n2cr" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2018/09/01/TypeScript-and-Babel-7/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">TypeScript and Babel 7</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/ECMAScript/">ECMAScript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/EDITOR/">EDITOR</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TypeScript/">TypeScript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/图像识别/">图像识别</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/ECMAScript/" style="font-size: 20px;">ECMAScript</a> <a href="/tags/EDITOR/" style="font-size: 10px;">EDITOR</a> <a href="/tags/TypeScript/" style="font-size: 15px;">TypeScript</a> <a href="/tags/图像识别/" style="font-size: 10px;">图像识别</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">September 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">August 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">June 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">April 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">July 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">June 2016</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2018/09/02/socket/">socket</a>
          </li>
        
          <li>
            <a href="/2018/09/01/TypeScript-and-Babel-7/">TypeScript and Babel 7</a>
          </li>
        
          <li>
            <a href="/2018/08/29/JavaScript-engine-fundamentals-optimizing-prototypes/">JavaScript engine fundamentals: optimizing prototypes</a>
          </li>
        
          <li>
            <a href="/2018/08/26/perf-notes/">perf_notes</a>
          </li>
        
          <li>
            <a href="/2018/06/24/Redux-vs-MobX/">Redux vs MobX</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2018 chegde<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>